pipeline {
  agent any
  parameters {
    string(description: 'enter ami_id', name: 'AMI_ID', defaultValue: 'ami-0ad42f4f66f6c1cc9')
    string(description: 'enter subnet id', name: 'SUBNET', defaultValue: 'subnet-0b57a25fd5a0448d0')
    string(description: 'enter region name', name: 'REGION', defaultValue: 'ap-south-1')
    string(description: 'enter Key name', name: 'TAG_KEY', defaultValue: 'Name')
    string(description: 'enter Key-value-name', name: 'TAG_VALUE', defaultValue: 'Jee4')
    string(description: 'enter instance-type', name: 'INSTANCE_TYPE', defaultValue: 't2.micro')
    string(description: 'enter security-group-id', name: 'SECURITY_GROUP_ID', defaultValue: 'sg-088974251af4f8415')
    choice(choices: ['CI_VPC', 'test1'], description: 'choose key pair?', name: 'KEYPAIR')
    
  }
     
  stages {
    stage('build') {
      steps {
      
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: 'aws-access',
          accessKeyVariable: 'AWS_ACCESS_KEY_ID',
          secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
        ]])
        {
       
          git url: 'https://github.com/usman6745/client-aws-instance-launch1.git'
          sh '''
          chmod +x properfunc.sh
            ./properfunc.sh $AMI_ID $KEYPAIR $SUBNET $REGION $TAG_KEY $TAG_VALUE $INSTANCE_TYPE $SECURITY_GROUP_ID
            cat InstanceId
           ''' 
      }
    }   
    }
    
    
    stage('slacknotification') {
 steps{    
def my_id = ''
dir ('/var/lib/jenkins/workspace/EC2_Launch-aws'){
my_id = sh(script:"head -1 InstanceId", returnStdout: true)
echo "${my_id}"
}
echo "${my_id}"
 slackSend baseUrl: 'https://opstree.slack.com/services/hooks/jenkins-ci/',
 channel: '#ec2-test',
 color: 'good',
 message: 'Jenkins-Slack Intigrated Instance-id is Launched - The Instance ID is ' + my_id,
 teamDomain: 'opstree',
 tokenCredentialId: 'slack-token-ec2-test'
 }
 }
    
    
    
     
    
 //stage('slacknotification') {
 //steps{      
 //slackSend baseUrl: 'https://opstree.slack.com/services/hooks/jenkins-ci/',
 //channel: 'ot-meesho',
 //color: 'good',
 //message: 'Jenkins-Slack Intigrated Instance-id is Launched - The Instance ID is ${env.id}',
 //teamDomain: 'opstree',
 //tokenCredentialId: 'slack-token'
 //}
 //}
     //stage('emailnotification') {
     //steps{
     //emailext attachLog: true, body: 'Hello, this is a test mail', subject: 'Email-Push', to: 'usman.mohammed@opstree.com'
     //}
     //}
                                  // stage('email-extended') {
                                //   steps{
                              
}

//post {
  //                                    always {
    //                                  script {
      //                                if (currentBuild.currentResult == 'SUCCESS') { // Other values: SUCCESS, UNSTABLE
                                      ////// Send an email only if the build status has changed from green/unstable to red
        //                              emailext subject: '$DEFAULT_SUBJECT',
          //                            body: '$DEFAULT_CONTENT',
            //                          replyTo: '$DEFAULT_REPLYTO',
              //                        to: '$DEFAULT_RECIPIENTS'
                                   //        }
                                     //     }
                                      //}
                                 // }
                                 // }
                                  //}


}
